#!/bin/bash

set -e

failing_tests_branch=static-analysis-failures

already_tracked() {
    [[ $# -eq 1 ]] || return
    local file=$1
    git ls-files --error-unmatch "$file" >/dev/null 2>&1
}

commit_file() {
    [[ $# -eq 2 ]] || return
    local file=$1
    local message=$2
    git add "$file"
    git commit -m "$message" >/dev/null
}


declare -a failures=() success=() regressions=()

for test in test/static_analysis/{aioretry,retry}*py; do
    if mypy "$test" >/dev/null 2>&1; then
	printf '%s: success' "$test"
	success+=("$test")
	if already_tracked "$test"; then
	    if commit_file "$test" "Update working $test test file"; then
		printf ' (updated)'
	    else
		printf ' (unchanged)'
	    fi
	elif commit_file "$test" "Add newly-working $test test file"; then
	    printf ' (NEW!)'
	fi
	printf \\n
    else
	printf '%s: failed' "$test"
	if already_tracked "$test"; then
	    printf ' (REGRESSION!)'
	    regressions+=("$test")
	else
	    failures+=("$test")
	fi
	printf \\n
    fi
done

if [[ ${#regressions[@]} -ne 0 ]]; then
    printf '%d regressions detected\n' "${#regressions[@]}"
    printf '* %s\n' "${regressions[@]}"
fi

if [[ ${#failures[@]} -eq 0 ]]; then
    echo "No new failure detected"
    exit
fi

printf '%d tess still failing:\n' "${#failures[@]}"
printf '* %s\n' "${failures[@]}"

rm -f "${failures[@]}"

[[ -z $SAVE_FAILURE ]] && exit

current_branch=$(git branch --show-current)

git checkout "$failing_tests_branch"
git rebase "$current_branch"

REVEAL_TYPES=1 tools/generate-tests "${failures[@]}"
git add "${failures[@]}"
git commit -m "add currently-failing static analysis test files"

git checkout -
